---
title: Lazy Initilization of useState
date: 2025-07-28
category: 'react'
---

# useState çš„lazy initialization

è¿™æ˜¯ä¸€ä¸ªå¾ˆç»å…¸çš„é—®é¢˜ï¼ŒReact çš„ `useState` åœ¨æŽ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°æ—¶æœ‰**ä¸¤ç§ä¸åŒçš„è¡Œä¸º**ï¼Œä½ éœ€è¦æ ¹æ®**æ˜¯å¦åŒ…è£¹åœ¨å‡½æ•°ä½“å†…**æ¥åˆ¤æ–­ã€‚

---

## âœ… ç»“è®ºæ€»ç»“ï¼š

### æƒ…å†µä¸€ï¼šç›´æŽ¥ä¼ å‡½æ•° ðŸ‘‰ **å‡½æ•°ä¼šè¢«å½“ä½œå€¼æ¥æ‰§è¡Œ**

```jsx
const [count, setCount] = useState(() => {
  console.log('init') // âœ… åªæ‰§è¡Œä¸€æ¬¡
  return 0
})
```

> âœ… ç”¨å‡½æ•°åŒ…è£…èµ·æ¥æ—¶ï¼Œå®ƒæ˜¯**æƒ°æ€§åˆå§‹åŒ–ï¼ˆlazy initializationï¼‰**ã€‚åªæœ‰ç¬¬ä¸€æ¬¡æ¸²æŸ“æ‰ä¼šæ‰§è¡Œè¿™ä¸ªå‡½æ•°ã€‚

---

### æƒ…å†µäºŒï¼šä¸åŒ…è£¹å‡½æ•° ðŸ‘‰ **ç«‹å³æ‰§è¡Œå‡½æ•°ï¼Œç»“æžœä½œä¸ºåˆå§‹å€¼**

```jsx
const [count, setCount] = useState(() => {
  return expensiveComputation() // ðŸ§¨ æ¯æ¬¡æ¸²æŸ“éƒ½ä¼šæ‰§è¡Œï¼ˆé”™è¯¯ç”¨æ³•ï¼‰
})
```

å¦‚æžœä½ è¿™æ ·å†™ï¼š

```jsx
const [count, setCount] = useState(expensiveComputation())
```

> âŒ è¿™é‡Œ `expensiveComputation()` æ˜¯**ç›´æŽ¥æ‰§è¡Œçš„ç»“æžœ**ï¼Œä¸æ˜¯â€œåˆå§‹åŒ–å‡½æ•°â€ã€‚
> æ‰€ä»¥ä¼šæ¯æ¬¡ç»„ä»¶å‡½æ•°è¿è¡Œæ—¶éƒ½æ‰§è¡Œå®ƒï¼Œå³ä½¿å®ƒåªæ˜¯ç”¨æ¥ç”Ÿæˆåˆå§‹å€¼ã€‚

---

## ðŸ§  ç”¨é€”ï¼šä¸ºä»€ä¹ˆç”¨å‡½æ•°åˆå§‹åŒ–ï¼Ÿ

```jsx
const [data, setData] = useState(() => loadFromLocalStorage())
```

è¿™æ˜¯æŽ¨èå†™æ³•ï¼Œå› ä¸ºï¼š

- `loadFromLocalStorage()` æ˜¯ä¸ªå¼€é”€å¤§çš„æ“ä½œ
- ç”¨å‡½æ•°åŒ…è£¹åŽï¼Œå®ƒåªä¼šåœ¨ **ç¬¬ä¸€æ¬¡æ¸²æŸ“** æ—¶è¢«æ‰§è¡Œ
- åŽç»­ re-render ä¸ä¼šå†è·‘è¿™ä¸ªå‡½æ•°ï¼Œæé«˜æ€§èƒ½ âœ…

---

## ðŸ” å†…éƒ¨æœºåˆ¶ç®€è¿°

React å†…éƒ¨ä¼šæ£€æŸ¥ä½ ä¼ ç»™ `useState` çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼š

- å¦‚æžœæ˜¯**å‡½æ•°ç±»åž‹**ï¼šè®¤ä¸ºä½ è¦ç”¨**æƒ°æ€§åˆå§‹åŒ–**ï¼Œåªæ‰§è¡Œä¸€æ¬¡
- å¦‚æžœæ˜¯æ™®é€šå€¼ï¼ˆåŒ…æ‹¬å‡½æ•°è°ƒç”¨çš„è¿”å›žå€¼ï¼‰ï¼šç›´æŽ¥ä½¿ç”¨è¯¥å€¼ä½œä¸ºåˆå§‹ state

---

## âœ… æŽ¨èå†™æ³•ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰

```jsx
const [state, setState] = useState(() => expensiveInit())
```

---

å¦‚æžœä½ è¿˜æƒ³äº†è§£ `useMemo`, `useCallback` å’Œ `useState(() => {})` çš„åŒºåˆ«ï¼Œä¹Ÿå¯ä»¥é—®æˆ‘ç»§ç»­è®²è§£ã€‚

åœ¨ React ä¸­ï¼Œ`useState` çš„å‚æ•°æ—¢å¯ä»¥æ˜¯ä¸€ä¸ªâ€œç›´æŽ¥å€¼â€ï¼ˆæ¯”å¦‚æ•°å­—ã€å­—ç¬¦ä¸²ã€å¯¹è±¡â€¦â€¦ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªâ€œå‡½æ•°â€ã€‚å½“ä½ ä¼ å…¥ä¸€ä¸ªå‡½æ•°ä½œä¸ºåˆå§‹çŠ¶æ€æ—¶ï¼ŒReact ä¼šæŠŠå®ƒå½“ä½œ **æƒ°æ€§åˆå§‹åŒ–å‡½æ•°ï¼ˆlazy initializerï¼‰** æ¥å¤„ç†ï¼Œè€Œä¸æ˜¯æŠŠè¿™ä¸ªå‡½æ•°æœ¬èº«å½“ä½œçŠ¶æ€å€¼ã€‚

---

## 1. æƒ°æ€§åˆå§‹åŒ–å‡½æ•°çš„ä½œç”¨

```jsx
// ç›´æŽ¥ä¼ å€¼ï¼šæ¯æ¬¡ç»„ä»¶æ¸²æŸ“ï¼Œè®¡ç®—è¡¨è¾¾å¼éƒ½ä¼šæ‰§è¡Œ
const [count, setCount] = useState(expensiveComputation())

// æƒ°æ€§åˆå§‹åŒ–ï¼šexpensiveComputation åªåœ¨åˆæ¬¡æ¸²æŸ“æ—¶æ‰§è¡Œä¸€æ¬¡
const [count, setCount] = useState(() => expensiveComputation())
```

- **ç›´æŽ¥ä¼ å€¼**
  `useState(expensiveComputation())` ä¼šåœ¨æ¯æ¬¡ç»„ä»¶æ¸²æŸ“æ—¶éƒ½è°ƒç”¨ä¸€æ¬¡ `expensiveComputation()`ï¼Œç„¶åŽæŠŠå®ƒçš„è¿”å›žå€¼å½“ä½œåˆå§‹çŠ¶æ€ä¼ ç»™ Reactã€‚ï¼ˆè™½ç„¶ React åªä¼šåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶çœŸæ­£â€œå­˜â€è¿™ä¸ªå€¼ï¼Œä½†è°ƒç”¨å‡½æ•°çš„å¼€é”€å·²ç»å‘ç”Ÿäº†ã€‚ï¼‰
- **æƒ°æ€§åˆå§‹åŒ–**
  `useState(() => expensiveComputation())` ä¼ å…¥äº†ä¸€ä¸ªå‡½æ•°ï¼ŒReact åªä¼šåœ¨ **ç¬¬ä¸€æ¬¡** æ¸²æŸ“æ—¶æ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œå°†å®ƒçš„è¿”å›žå€¼è®¾ä¸ºåˆå§‹çŠ¶æ€ï¼›åŽç»­æ¸²æŸ“å®Œå…¨ä¸ä¼šå†æ¬¡è°ƒç”¨å®ƒï¼Œä»Žè€Œé¿å…é‡å¤å¼€é”€ã€‚

---

## 2. æƒ°æ€§åˆå§‹åŒ–çš„å…¸åž‹åœºæ™¯

- **æ˜‚è´µè®¡ç®—**ï¼šéœ€è¦ä»Žå¤§æ•°æ®ã€å¤æ‚ç®—æ³•æˆ–æœ¬åœ°ç¼“å­˜ä¸­è¯»å–åˆå§‹å€¼æ—¶
- **ä»Ž `localStorage` æ¢å¤çŠ¶æ€**ï¼šåªæƒ³åœ¨ç»„ä»¶é¦–æ¸²æŸ“æ—¶åŒæ­¥ä¸€æ¬¡
- **é¿å…é‡å¤é—­åŒ…åˆ›å»º**ï¼šå½“åˆå§‹çŠ¶æ€æ˜¯ä¸€ä¸ªå¯¹è±¡æˆ–æ•°ç»„ï¼Œéœ€è¦ä¸€æ¬¡æ€§ç”Ÿæˆï¼Œä¸”ä¸å¸Œæœ›æ¯æ¬¡æ¸²æŸ“éƒ½é‡å»º

```jsx
function Counter() {
  const [initialValue] = useState(() => {
    const saved = window.localStorage.getItem('count')
    return saved != null ? JSON.parse(saved) : 0
  })

  const [count, setCount] = useState(initialValue)
  // ...
}
```

---

## 3. å¦‚ä½•åœ¨çŠ¶æ€ä¸­å­˜å‚¨ä¸€ä¸ªå‡½æ•°

å¦‚æžœä½ çš„åˆè¡·æ˜¯æŠŠä¸€ä¸ªå‡½æ•°æœ¬èº«å½“ä½œçŠ¶æ€å€¼ï¼ˆè€Œä¸æ˜¯è°ƒç”¨å®ƒæ¥ç”ŸæˆçŠ¶æ€ï¼‰ï¼Œä½ éœ€è¦å†åŒ…ä¸€å±‚ï¼š

```jsx
// æƒ³è¦ state æœ¬èº«å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼ˆdoSomethingï¼‰
const [doSomething, setDoSomething] = useState(() => () => {
  console.log('Hello!')
})

// ä½¿ç”¨æ—¶ç›´æŽ¥è°ƒç”¨
doSomething()
```

è¿™æ ·ï¼ŒReact ä¼šæ‰§è¡Œæœ€å¤–å±‚çš„æƒ°æ€§åˆå§‹åŒ–å‡½æ•° `() => () => { â€¦ }`ï¼Œå¹¶æŠŠå†…å±‚çš„å‡½æ•° `() => { â€¦ }` ä½œä¸ºçŠ¶æ€å€¼ä¿å­˜ä¸‹æ¥ã€‚

---

## 4. å°ç»“

- **ä¼ å…¥æ™®é€šå€¼**ï¼š`useState(123)` â‡’ åˆå§‹çŠ¶æ€å°±æ˜¯ `123`
- **ä¼ å…¥å‡½æ•°**ï¼š`useState(() => 123)` â‡’ React è°ƒç”¨è¯¥å‡½æ•°ä¸€æ¬¡ï¼ŒæŠŠè¿”å›žå€¼ `123` è®¾ä¸ºåˆå§‹çŠ¶æ€
- **æƒ³æŠŠå‡½æ•°æœ¬èº«å­˜è¿›åŽ»**ï¼š`useState(() => yourFunction)` â‡’ åˆå§‹çŠ¶æ€å°±æ˜¯ `yourFunction`

é€šè¿‡æƒ°æ€§åˆå§‹åŒ–ï¼Œä½ å¯ä»¥æŠŠâ€œåªéœ€æ‰§è¡Œä¸€æ¬¡çš„æ˜‚è´µè®¡ç®—â€é«˜æ•ˆåœ°é›†æˆåˆ°ç»„ä»¶çŠ¶æ€é‡Œï¼Œè€Œä¸ç”¨æ‹…å¿ƒé¢å¤–çš„æ€§èƒ½æŸè€—ã€‚

åœ¨ React æºç é‡Œï¼Œ`useState` å¯¹å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æœ‰è¿™æ ·çš„å¤„ç†é€»è¾‘ï¼š

```js
// ä¼ªä»£ç ï¼Œç®€åŒ–ç‰ˆ
function mountState(initialState) {
  // å¦‚æžœ initialState æ˜¯å‡½æ•°ï¼Œå°±æ‰§è¡Œå®ƒï¼Œå¹¶æŠŠè¿”å›žå€¼å½“ä½œçœŸæ­£çš„åˆå§‹ state
  const state = typeof initialState === 'function' ? initialState() : initialState
  // â€¦å°† state å­˜åˆ° Hook é‡Œï¼Œåªåœ¨åˆæ¬¡æ¸²æŸ“æ—¶ç”¨è¿™æ®µé€»è¾‘â€¦
}
```

---

### 1. å½“ä½ å†™ `useState(expensiveComputation())`

- **å‡½æ•°ä½“æ‰§è¡Œæµç¨‹**
  æ¯æ¬¡ç»„ä»¶æ¸²æŸ“ï¼ˆæ¯æ¬¡ React è°ƒç”¨ä½ çš„ç»„ä»¶å‡½æ•°ï¼‰éƒ½ä¼šå…ˆèµ°åˆ°è¿™ä¸€è¡Œï¼Œå°±ç«‹åˆ»æ‰§è¡Œ `expensiveComputation()`ï¼Œæ— è®ºè¿™ä¸ªæ¸²æŸ“æ˜¯ä¸æ˜¯ã€Œç¬¬ä¸€æ¬¡ã€ã€‚
- **ç»“æžœ**
  è™½ç„¶åŽç»­æ¸²æŸ“æ—¶ React å¹¶ä¸ä¼šæŠŠæ–°çš„è¿”å›žå€¼å†æ”¾è¿› stateï¼ˆstate åªåœ¨åˆæ¬¡æ¸²æŸ“æ—¶è®¾ç½®ï¼‰ï¼Œä½†**æ¯æ¬¡æ¸²æŸ“**éƒ½ä¼šè§¦å‘é‚£æ¬¡å¼€é”€å¤§çš„è®¡ç®—ã€‚

---

### 2. å½“ä½ å†™ `useState(() => expensiveComputation())`

- **å‡½æ•°ä½“æ‰§è¡Œæµç¨‹**
  è¿™é‡Œä¼ ç»™ `useState` çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼ˆlazy initializerï¼‰ã€‚React çœ‹åˆ°ã€Œå‚æ•°ç±»åž‹æ˜¯å‡½æ•°ã€ï¼Œå°±**åªåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“**æ—¶æ‰è°ƒç”¨å®ƒä¸€æ¬¡ï¼Œä¹‹åŽå†æ¸²æŸ“å°±**ä¸ä¼šå†æ‰§è¡Œ**è¿™ä¸ªå‡½æ•°äº†ã€‚
- **ç»“æžœ**
  - **é¦–æ¬¡æ¸²æŸ“**ï¼šæ‰§è¡Œä¸€æ¬¡ `expensiveComputation()`ï¼Œå¹¶æŠŠå®ƒçš„è¿”å›žå€¼å½“ä½œåˆå§‹ stateã€‚
  - **åŽç»­æ¸²æŸ“**ï¼šå®Œå…¨è·³è¿‡è¿™æ®µè°ƒç”¨ï¼Œç›´æŽ¥ä½¿ç”¨å·²æœ‰çš„ stateï¼Œæ€§èƒ½å¼€é”€ä¸ºé›¶ã€‚

---

### ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Ÿ

1. **æ€§èƒ½è€ƒè™‘**
   å¦‚æžœæ¯æ¬¡æ¸²æŸ“éƒ½åšä¸€æ¬¡æ˜‚è´µè®¡ç®—ï¼ŒUI ä¼šå¡é¡¿ï¼›æä¾› lazy initializerï¼Œå¯ä»¥æŠŠå¼€é”€ã€ŒæŽ¨è¿Ÿåˆ°åªæœ‰ä¸€æ¬¡ã€ã€‚
2. **API è¯­ä¹‰**
   æŠŠã€Œç›´æŽ¥å€¼ã€å’Œã€Œæƒ°æ€§åˆå§‹åŒ–å‡½æ•°ã€åˆäºŒä¸ºä¸€çš„ APIï¼Œä½¿ç”¨æ—¶ä¹Ÿæ›´ç®€æ´ï¼Œä¸ç”¨å†™ä¸¤å¥—ã€‚

---

### å°ç»“

- `useState(expensiveComputation())` â†’ **é”™è¯¯ç”¨æ³•**ï¼Œæ¯æ¬¡æ¸²æŸ“éƒ½æ‰§è¡Œ `expensiveComputation()`
- `useState(() => expensiveComputation())` â†’ **æ­£ç¡®ç”¨æ³•**ï¼Œåªåœ¨ã€Œç»„ä»¶æŒ‚è½½ã€æ—¶æ‰§è¡Œä¸€æ¬¡

> **Tip:** å¦‚æžœä½ çš„åˆå§‹ state æœ¬èº«å°±æ˜¯ä¸€ä¸ªå‡½æ•°å¯¹è±¡ï¼ˆæ¯”å¦‚ä½ æƒ³æŠŠä¸€ä¸ªå‡½æ•°å½“æˆ state å­˜èµ·æ¥ï¼‰ï¼Œå¯ä»¥å†åŒ…ä¸€å±‚ï¼š
>
> ```js
> // æƒ³æŠŠ fn è¿™ä¸ªå‡½æ•°å½“æˆ state å­˜
> const [fnState] = useState(() => fn)
> ```
